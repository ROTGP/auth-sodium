<!-- ![Closures logo](https://raw.githubusercontent.com/vhesener/Closures/assets/assets/logo3.1.png) -->

<!-- [![Language](https://badgen.net/packagist/php/monolog/monolog)]()
[![License](https://img.shields.io/github/license/vhesener/Closures.svg?style=plastic&colorB=68B7EB)]()
[![Release](https://img.shields.io/github/release/vhesener/Closures.svg?style=plastic&colorB=68B7EB)]() -->

## AuthSodium

`AuthSodium` is a [Laravel](https://laravel.com/)
package for authenticating API requests with LibSodium's
[public-key (ED25519)
signatures](https://libsodium.gitbook.io/doc/public-key_cryptography/public-key_signatures).
Sodium is available natively in PHP since version 7.2
without an extension. Some objectives of the package:
  * use modern security standards
  * provide stateless RESTful API asymmetric authentication
  * remove complexity of clients having to request/renew tokens
  * manage
    [nonces](https://en.wikipedia.org/wiki/Cryptographic_nonce)
    transparently
  * throttle and block malicious users
  * highly customizable
  * non-invasive
  * no dependencies (other than Laravel itself)
  * thoroughly tested
  * fast and lightweight


## Contents
  - [Overview](#overview)
  - [Installation](#installation)
  - [Configuration](#configuration)
  - [License](#license)

## Overview

The package works by verifying the signature sent with each
authenticated request. The request must contain headers
with the following metadata: 
 - a unique identifier for the
user to be authenticated (like an email address)
 - a
   [nonce](https://en.wikipedia.org/wiki/Cryptographic_nonce)
 - a timestamp
 - a signature. 

The signature, which is generated by the client, is calculated by signing data
related to the request. This data is comprised of:
 - the HTTP **request method** (`get`, `put`, `post`, or `delete`)
 - the fully qualified **URL** of the request (with `the
   http://` or `https://www`), but without any query
   strings
 - **query data** (sorted alphabetically and json-encoded),
   or an empty string if empty
 - **post data** (json-encoded), or an empty string if empty
 - **user identifier** (such as the user's email address)
 - **timestamp** (either seconds or milliseconds, according
   to your config) since midnight January 1st 1970 (UTC)
 - **nonce** (a number or string which should not be repeated)

This data is then concatenated to make a single string,
which is then signed with the user's private key. The
signature is then sent as a header.

On the server side, this string is reconstructed. Once
the auth user has been retrieved, their public key is
used to verify the signature. If the signature fails
then the appropriate error response is returned,
otherwise, the request continues as per normal.

## Installation

1) Require this package with composer.

```shell
composer require rotgp/auth-sodium
```

2) Publish the AuthSodium config file to your project with
   the following command:

```shell
php artisan vendor:publish --provider="ROTGP\AuthSodium\AuthSodiumServiceProvider" --tag="config"
```

## Configuration

Assuming you've performed the above installation, the
config file can then be found at
`config/authsodium.php`. 

### User Model
The only thing you're REQUIRED to tell AuthSodium
about is the class of your user model. This must extend
`Illuminate\Database\Eloquent\Model`, and implement
`Illuminate\Contracts\Auth\Authenticatable`. For
convenience, the model may simply extend
`ROTGP\AuthSodium\Models\AuthSodiumUser` which already
meets these requirements.

`'user.model' => App\Models\User::class`

AuthSodium needs to know how to uniquely identify your
auth user. By default, this will be with the user's
`'email'` attribute, but you may choose anything, such
as username or even an id (assuming the user knows
their own id). 

`'user.unique_identifier' => 'username'`

You should also note that AuthSodium will look for the
user's public key using the `'public_key'` attribute of
the user model. If you wish to call it something else,
then you may do so as follows:

`'user.public_key_identifier' => 'pub_key'`

<br />


### Protecting routes with middleware

#### Named Middleware

By default, AuthSodium provides middleware called
`'authsodium'`. To protect a route, simply add the
middleware in the same way you'd normally add middleware
`Route::resource('foos',
FooController::class)->middleware('authsodium');` The
name of the middleware can be customized as follows:

`'middleware.name' => 'custom_middleware_name'`


#### Global Middleware

If you want to protect all incoming requests
automatically, then set `'middleware.global'` to true:

`'middleware.global' => true`


#### Middleware groups

If you want to add AuthSodium to a particular middleware
group (such as 'web', or 'api'), then you may do so as follows:

`'middleware.group' => 'api'`


#### Aborting requests

By default, AuthSodium will abort requests with invalid
signatures automatically, with the appropriate status
and error codes (which are customizable). There may
however be situations where you wish to proceed with the
request, without establishing an authenticated user. To
achieve this - set the following value to false.

`'middleware.abort_on_invalid_signature' => false`






<br /><br /><br /><br /><br />
## License

`AuthSodium` is provided under the [MIT License](https://github.com/vhesener/Closures/blob/master/LICENSE).
